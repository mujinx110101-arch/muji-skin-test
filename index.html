<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUJI 膚質檢測結果</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --muji-red: #7F0019; --muji-bg: #f4f1f0; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--muji-bg); margin: 0; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 450px; background: #fff; min-height: 100vh; padding: 20px; box-sizing: border-box; text-align: center; }
        .hidden { display: none; }
        .card { border: 1px solid #ddd; padding: 25px; background: white; margin-top: 10px; }
        .result-type { font-size: 24px; color: var(--muji-red); font-weight: bold; margin: 15px 0; }
        .product-box { background: #f9f9f9; padding: 15px; margin: 15px 0; text-align: left; border-left: 4px solid var(--muji-red); }
        .btn { background: var(--muji-red); color: #fff; border: none; padding: 15px; width: 100%; font-size: 16px; cursor: pointer; margin-top: 10px; }
        #download-area img { width: 100%; border: 1px solid #ccc; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .step-hint { font-size: 14px; color: #666; margin: 10px 0; }
    </style>
</head>
<body>

<div id="app">
    <div id="quiz-part">
        <h2 style="color:var(--muji-red); letter-spacing: 2px;">MUJI 無印良品</h2>
        <p>簡易膚質檢測系統</p>
        <div id="question-container">
            <h3 id="q-text">您洗臉後的狀態是？</h3>
            <div id="options">
                </div>
        </div>
    </div>

    <div id="result-part" class="hidden">
        <div id="capture-area" class="card">
            <div style="font-size: 12px; color: #888;">MUJI SKINCARE</div>
            <div class="result-type" id="res-name"></div>
            <p id="res-desc" style="font-size: 14px; color: #444;"></p>
            
            <div class="product-box">
                <div style="font-weight: bold; font-size: 14px;">推薦保養：</div>
                <div id="res-prod" style="font-size: 15px; margin-top: 5px;"></div>
            </div>

            <div style="text-align: left; font-size: 13px; color: #666;" id="res-tips"></div>
            
            <hr style="border: 0; border-top: 1px dashed #ccc; margin: 20px 0;">
            <div id="res-qrcode" style="display: flex; justify-content: center; margin-bottom: 5px;"></div>
            <div style="font-size: 10px; color: #aaa;">掃描此碼重新測驗</div>
        </div>

        <p class="step-hint" id="action-hint">正在為您準備下載檔案...</p>
        
        <div id="download-area">
            </div>
        
        <button class="btn" style="background:#666" onclick="window.location.href=window.location.pathname">重新測驗</button>
    </div>
</div>

<script>
    const data = {
        mixed: { name: "混合性肌膚", desc: "T字部位易出油，兩頰較乾燥。", prod: "敏感肌化妝水(清爽型)", tips: "• 分區保養<br>• 溫和清潔" },
        oily: { name: "油性肌膚", desc: "全臉油脂分泌旺盛，容易冒痘。", prod: "清新化妝水(草本)", tips: "• 加強控油<br>• 清爽保濕" },
        dry: { name: "乾性肌膚", desc: "肌膚缺水緊繃，容易產生細紋。", prod: "高保濕敏感肌化妝水", tips: "• 深度鎖水<br>• 使用乳霜" },
        sensitive: { name: "敏感性肌膚", desc: "屏障較薄，容易泛紅刺痛。", prod: "敏感肌系列(低刺激)", tips: "• 簡化保養<br>• 避免酒精" }
    };

    // 檢查網址是否有參數 (例如 ?type=oily)
    const urlParams = new URLSearchParams(window.location.search);
    const typeParam = urlParams.get('type');

    if (typeParam && data[typeParam]) {
        // 如果有參數，直接顯示結果
        renderResult(typeParam, true);
    } else {
        // 否則顯示第一題
        showQuestion();
    }

    function showQuestion() {
        const optionsDiv = document.getElementById('options');
        const types = Object.keys(data);
        types.forEach(t => {
            const b = document.createElement('button');
            b.className = 'btn';
            b.style.background = '#fff';
            b.style.color = '#333';
            b.style.border = '1px solid #ccc';
            b.innerText = data[t].name;
            b.onclick = () => renderResult(t, false);
            optionsDiv.appendChild(b);
        });
    }

    function renderResult(type, isFromScan) {
        document.getElementById('quiz-part').classList.add('hidden');
        document.getElementById('result-part').classList.remove('hidden');

        const res = data[type];
        document.getElementById('res-name').innerText = res.name;
        document.getElementById('res-desc').innerText = res.desc;
        document.getElementById('res-prod').innerText = res.prod;
        document.getElementById('res-tips').innerHTML = res.tips;

        // 產生回首頁的 QR Code (放進結果圖內)
        const homeUrl = window.location.origin + window.location.pathname;
        new QRCode(document.getElementById("res-qrcode"), { text: homeUrl, width: 60, height: 60 });

        // 如果是掃描進來的，我們直接幫他轉成圖片
        setTimeout(() => {
            autoGenerateImage(type, isFromScan);
        }, 500);
    }

    function autoGenerateImage(type, isFromScan) {
        const area = document.getElementById('capture-area');
        html2canvas(area).then(canvas => {
            const imgData = canvas.toDataURL("image/png");
            const img = new Image();
            img.src = imgData;
            document.getElementById('download-area').appendChild(img);
            
            if (isFromScan) {
                document.getElementById('action-hint').innerHTML = "✨ 檢測結果已送達！<br><b>長按上方圖片即可儲存至相簿</b>";
            } else {
                // 這是 iPad 端看到的畫面
                document.getElementById('action-hint').innerHTML = "請掃描下方 QR Code 領取您的結果圖";
                // 產生一個帶有結果參數的 QR Code 讓客人掃
                const resultUrl = window.location.origin + window.location.pathname + "?type=" + type;
                document.getElementById('download-area').innerHTML = ""; // 清空圖片，改放 QR Code
                const qrContainer = document.createElement('div');
                qrContainer.style.display = "flex";
                qrContainer.style.justifyContent = "center";
                qrContainer.style.padding = "20px";
                document.getElementById('download-area').appendChild(qrContainer);
                
                new QRCode(qrContainer, { text: resultUrl, width: 200, height: 200 });
            }
        });
    }
</script>

</body>
</html>